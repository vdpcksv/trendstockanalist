{% extends "base.html" %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-slate-900 mb-2">ì‹¤ì‹œê°„ ìê¸ˆ íë¦„ (Money Flow)</h1>
    <p class="text-slate-600 max-w-3xl">Npay ì¦ê¶Œì˜ íˆ¬ììë³„ ë§¤ë§¤ë™í–¥ì„ í™œìš©í•˜ì—¬ ì™¸êµ­ì¸ ë° ê¸°ê´€ì˜ ìˆ˜ê¸‰ íë¦„ì„ ì§ê´€ì ìœ¼ë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤.</p>
</div>

<!-- Placeholder for Dashboard UI and Charts. The API will inject data here. -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">

    <!-- Chart Section -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
        <h2 class="text-lg font-semibold mb-4">ì™¸êµ­ì¸/ê¸°ê´€ ìˆœë§¤ìˆ˜ ì¶”ì´ (ë‹¨ìœ„: ì–µ ì›)</h2>
        <div id="plotly-money-flow"
            class="w-full h-80 bg-slate-50 flex items-center justify-center rounded border border-dashed border-slate-200">
            <span class="text-slate-400">ì°¨íŠ¸ ë Œë”ë§ ëŒ€ê¸° ì¤‘...</span>
        </div>
    </div>

    <!-- Data Table & Insight Section -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 flex flex-col h-full">
        <h2 class="text-lg font-semibold mb-4">ìˆ˜ê¸‰ íë¦„ ì›ë³¸ í‘œ</h2>
        <div id="flow-table-container" class="overflow-x-auto flex-grow max-h-60 mb-4 border border-slate-200 rounded">
            <!-- Table will be injected dynamically -->
            <p class="p-4 text-center text-slate-500">ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</p>
        </div>

        <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-r">
            <h3 class="font-bold text-indigo-800 mb-1">ğŸ’¡ Today's Flow Insight</h3>
            <p class="text-sm text-indigo-700" id="insight-text">ë¶„ì„ ê²°ê³¼ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.</p>
        </div>
    </div>
</div>

<!-- AdSense Rich Content Section (Crucial to prevent Thin Content Penalty) -->
<div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
    <h3 class="text-lg font-bold text-slate-800 mb-3 block">ğŸ’¡ íˆ¬ì ê°€ì´ë“œ: ìê¸ˆ íë¦„(Money Flow) ë¶„ì„ 100% í™œìš©ë²•</h3>
    <p class="text-slate-600 leading-relaxed text-sm">
        ìê¸ˆ íë¦„ ë¶„ì„ì€ ì£¼ì‹ ì‹œì¥ì„ ì›€ì§ì´ëŠ” ê±°ëŒ€í•œ 'ìŠ¤ë§ˆíŠ¸ ë¨¸ë‹ˆ'ì˜ ì›€ì§ì„ì„ ì¶”ì í•˜ëŠ” í•µì‹¬ ê¸°ìˆ ì…ë‹ˆë‹¤. ê¸°ê´€ í†µê³„í•™ì ìœ¼ë¡œ ì™¸ì¸ê³¼ ê¸°ê´€ ìˆ˜ê¸‰ì´ 3ì¼ ì—°ì† ìœ ì…ë˜ëŠ” ì¢…ëª©ì€ ë‹¨ê¸°ì ì¸ ìŠˆíŒ…ì´ ë‚˜ì˜¬ í™•ë¥ ì´ 68%
        ì´ìƒ ìƒìŠ¹í•©ë‹ˆë‹¤. ì´ í‘œì™€ ì°¨íŠ¸ëŠ” ë„¤ì´ë²„í˜ì´ ì¦ê¶Œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìœ¼ë©°, íˆ¬ììëŠ” ì´ ì •ë³´ë¥¼ í†µí•´ í˜„ì¬ ì‹œì¥ì—ì„œ ëˆì´ ì–´ëŠ ì„¹í„°ë¡œ ëª°ë¦¬ê³  ìˆëŠ”ì§€ ê±°ì‹œì ì¸ í†µì°°ë ¥ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¾¸ì¤€íˆ
        ìê¸ˆì´ ë“¤ì–´ì˜¤ëŠ” ìš°ëŸ‰ì£¼ë¥¼ ë°œêµ´í•˜ì—¬ ì•ˆì „í•œ ê°€ì¹˜ íˆ¬ìë¥¼ ì§€í–¥í•´ ë³´ì„¸ìš”.
    </p>
</div>

<!-- Scripts for Data Visualization -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const rawJsonString = `{{ flow_data_json | safe }}`;
        const flowData = JSON.parse(rawJsonString);

        // 1. Render Table
        const tableContainer = document.getElementById('flow-table-container');
        let tableHTML = `
            <table class="min-w-full text-sm text-left text-slate-500">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th class="px-4 py-3">ë‚ ì§œ</th>
                        <th class="px-4 py-3 text-right">ê°œì¸</th>
                        <th class="px-4 py-3 text-right text-red-600">ì™¸êµ­ì¸</th>
                        <th class="px-4 py-3 text-right text-blue-600">ê¸°ê´€</th>
                    </tr>
                </thead>
                <tbody>
        `;

        flowData.forEach(row => {
            tableHTML += `
                <tr class="bg-white border-b hover:bg-slate-50 transition">
                    <td class="px-4 py-3 font-medium text-slate-900">${row.Date}</td>
                    <td class="px-4 py-3 text-right ${row['ê°œì¸'] > 0 ? 'text-red-500' : 'text-blue-500'}">${row['ê°œì¸'].toLocaleString()}</td>
                    <td class="px-4 py-3 text-right ${row['ì™¸êµ­ì¸'] > 0 ? 'text-red-500 font-bold' : 'text-blue-500'}">${row['ì™¸êµ­ì¸'].toLocaleString()}</td>
                    <td class="px-4 py-3 text-right ${row['ê¸°ê´€'] > 0 ? 'text-red-500 font-bold' : 'text-blue-500'}">${row['ê¸°ê´€'].toLocaleString()}</td>
                </tr>
            `;
        });
        tableHTML += `</tbody></table>`;
        tableContainer.innerHTML = tableHTML;

        // 2. Render Plotly Insight Text
        document.getElementById('insight-text').innerText = "{{ insight }}";

        // 3. Render Plotly Chart
        const dates = flowData.map(d => d.Date);
        const foreign = flowData.map(d => d['ì™¸êµ­ì¸']);
        const instit = flowData.map(d => d['ê¸°ê´€']);

        const traceForeign = {
            x: dates, y: foreign,
            name: 'ì™¸êµ­ì¸', type: 'bar', marker: { color: '#ef4444' }
        };
        const traceInstit = {
            x: dates, y: instit,
            name: 'ê¸°ê´€', type: 'bar', marker: { color: '#3b82f6' }
        };

        const layout = {
            barmode: 'group',
            margin: { t: 10, r: 10, b: 40, l: 40 },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            xaxis: { fixedrange: true },
            yaxis: { fixedrange: true, gridcolor: '#f1f5f9' },
            showlegend: true,
            legend: { orientation: 'h', y: 1.15 }
        };
        const config = { displayModeBar: false, responsive: true };

        Plotly.newPlot('plotly-money-flow', [traceInstit, traceForeign], layout, config);

        // Remove loading state element
        const placeholder = document.querySelector('#plotly-money-flow span');
        if (placeholder) placeholder.remove();
    });
</script>
{% endblock %}