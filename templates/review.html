{% extends "base.html" %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-slate-900 mb-2">ê¸°ìˆ ì  ë§¤ë§¤ ë³µê¸° ë° í€€íŠ¸ ì§„ë‹¨</h1>
    <p class="text-slate-600 max-w-3xl">ì…ë ¥í•˜ì‹  ì¢…ëª©ì˜ ê³¼ê±° íë¦„ì„ ì² ì €íˆ ë³µê¸°í•˜ê³ , AI ê¸°ë°˜ì˜ í€€íŠ¸ ì§€í‘œë¥¼ í†µí•´ í˜„ì¬ ì£¼ê°€ì˜ ìƒìŠ¹ ë™ë ¥ì„ ìˆ˜ì¹˜í™”í•˜ì—¬ ì œê³µí•©ë‹ˆë‹¤.</p>
</div>

<!-- Search Form -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 mb-8">
    <form method="get" action="/review" class="flex flex-col sm:flex-row gap-4">
        <div class="flex-grow">
            <label for="ticker" class="sr-only">ì¢…ëª© ì½”ë“œ 6ìë¦¬</label>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <span class="text-slate-500 sm:text-sm">ğŸ”</span>
                </div>
                <input type="text" name="ticker" id="ticker" value="{{ ticker }}"
                    class="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-md leading-5 bg-white placeholder-slate-500 focus:outline-none focus:placeholder-slate-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    placeholder="ì¢…ëª© ì½”ë“œ 6ìë¦¬ ì…ë ¥ (ì˜ˆ: 005930)" required pattern="[0-9]{6}">
            </div>
            <p class="mt-2 text-xs text-slate-500">â€» ì¢…ëª©ì˜ ê³ ìœ  ìˆ«ì 6ìë¦¬ í‹°ì»¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
        </div>
        <button type="submit"
            class="w-full sm:w-auto flex justify-center py-3 px-8 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            ì°¨íŠ¸ ë° AI ì§„ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸°
        </button>
    </form>
</div>

{% if error %}
<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative mb-8" role="alert">
    <span class="block sm:inline">{{ error }}</span>
</div>
{% endif %}

{% if chart_data and ai_score %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
    <!-- Chart Area -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 lg:col-span-2">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-slate-800">ğŸ“Š 6ê°œì›” ê¸°ìˆ ì  ìº”ë“¤ ì°¨íŠ¸ ({{ ticker }})</h2>

            <!-- Indicator Toggles -->
            <div class="flex space-x-4 text-sm bg-slate-100 p-1 rounded-lg">
                <label class="flex items-center space-x-2 cursor-pointer px-2">
                    <input type="checkbox" id="toggle-ma"
                        class="form-checkbox h-4 w-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500"
                        checked>
                    <span class="text-slate-700">ì´ë™í‰ê· ì„ (MA5,20,60)</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer px-2">
                    <input type="checkbox" id="toggle-bb"
                        class="form-checkbox h-4 w-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500"
                        checked>
                    <span class="text-slate-700">ë³¼ë¦°ì €ë°´ë“œ(20,2)</span>
                </label>
            </div>
        </div>

        <div id="plotly-candlestick" class="w-full h-96 bg-slate-50 border border-slate-200 rounded"></div>
        <div id="plotly-rsi" class="w-full h-40 bg-slate-50 border border-slate-200 rounded mt-4"></div>
    </div>

    <!-- AI Score Dashboard -->
    <div
        class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 flex flex-col items-center justify-center text-center">
        <h2 class="text-lg font-semibold mb-6 text-slate-800 w-full border-b pb-2">ğŸ¤– AI í€€íŠ¸ ì¢…í•© ë¶„ì„ ë¦¬í¬íŠ¸</h2>

        <div class="relative mb-6">
            <!-- Score Circle -->
            <svg class="w-32 h-32 transform -rotate-90">
                <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="12" fill="transparent"
                    class="text-slate-100" />
                <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="12" fill="transparent"
                    stroke-dasharray="351.858" stroke-dashoffset="{{ 351.858 - (351.858 * ai_score.score) / 100 }}"
                    class="{% if ai_score.score >= 80 %}text-green-500{% elif ai_score.score >= 60 %}text-blue-500{% elif ai_score.score >= 40 %}text-yellow-500{% else %}text-red-500{% endif %} transition-all duration-1000 ease-out" />
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span class="text-3xl font-bold text-slate-800">{{ ai_score.score }}</span>
                <span class="text-xs text-slate-500">Score</span>
            </div>
        </div>

        <div class="w-full bg-slate-50 rounded-lg p-4 text-left border border-slate-200">
            <h3 class="text-sm font-bold text-slate-700 mb-1">í˜„ì¬ ì‹œì¥ êµ­ë©´ (Phase)</h3>
            <p
                class="text-lg font-semibold {% if 'ë§¤ìˆ˜' in ai_score.phase %}text-green-600{% elif 'ê´€ë§' in ai_score.phase %}text-yellow-600{% else %}text-red-600{% endif %}">
                {{ ai_score.phase }}</p>

            <div class="mt-4 border-t border-slate-200 pt-3">
                <h3 class="text-sm font-bold text-slate-700 mb-1">RSI ì¶”ì„¸ ê°•ë„ (14ì¼)</h3>
                <div class="flex items-center justify-between">
                    <span class="text-2xl font-bold text-slate-800">{{ ai_score.rsi }}</span>
                    <span class="text-xs text-slate-500 bg-white border px-2 py-1 rounded">
                        {% if ai_score.rsi < 30 %}ê³¼ë§¤ë„êµ¬ê°„{% elif ai_score.rsi> 70 %}ê³¼ë§¤ìˆ˜êµ¬ê°„{% else %}ì¶”ì„¸ì•ˆì •{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <p class="mt-6 text-xs text-slate-400 text-left">
            * ë³¸ AI ì§„ë‹¨ì€ ê°€ê²© ëª¨ë©˜í…€ê³¼ ê¸°ìˆ ì  ì§€í‘œì˜ ì´ê²©ë„ë¥¼ ìˆ˜í•™ì ìœ¼ë¡œ ì—°ì‚°í•œ ê²°ê³¼ì…ë‹ˆë‹¤. ë§¹ì‹ ì€ ê¸ˆë¬¼ì´ë©°, ì°¸ê³ ìš© ë³´ì¡° ì§€í‘œë¡œë§Œ í™œìš©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤. ë‚´ë¶€ ì—°ì‚° ì•Œê³ ë¦¬ì¦˜(ìˆ˜ì‹)ì€ ì „ëµ ë³´ì•ˆìƒì˜
            ì´ìœ ë¡œ ê³µê°œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
    </div>
</div>

{% if fundamentals and fundamentals.data %}
<!-- Fundamental Analysis Section -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 mb-12">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-slate-800">ğŸ¢ í•µì‹¬ ì¬ë¬´ì œí‘œ ë° í–¥í›„ ì„±ì¥ì„± ì§„ë‹¨ (Fundamental)</h2>
        <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">ë°ì´í„°: ë„¤ì´ë²„í˜ì´ ì¦ê¶Œ</span>
    </div>
    <p class="text-slate-600 text-sm mb-6">ê¸°ì—…ì˜ ë§¤ì¶œì•¡, ì˜ì—…ì´ìµ ì„±ì¥ì„±ê³¼ ë¶€ì±„ë¹„ìœ¨ ë“± ì•ˆì •ì„± ì§€í‘œ, ê·¸ë¦¬ê³  í–¥í›„ ì»¨ì„¼ì„œìŠ¤(E)ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ì ê²€í•©ë‹ˆë‹¤.</p>

    <div class="overflow-x-auto pb-4 custom-scrollbar">
        <table class="min-w-full text-sm text-right text-slate-600 border border-slate-200 whitespace-nowrap">
            <thead class="bg-slate-50 border-b border-slate-200 text-slate-700">
                <tr>
                    <th
                        class="px-4 py-3 text-left font-semibold border-r border-slate-200 bg-slate-100 sticky left-0 z-10 w-40">
                        ì£¼ìš” ì§€í‘œ</th>
                    {% for header in fundamentals.headers %}
                    <th class="px-4 py-3 font-semibold min-w-[100px]">{{ header }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% set target_keys = [
                ('ë§¤ì¶œì•¡', 'ì–µ ì›'),
                ('ì˜ì—…ì´ìµ', 'ì–µ ì›'),
                ('ë‹¹ê¸°ìˆœì´ìµ', 'ì–µ ì›'),
                ('ë¶€ì±„ë¹„ìœ¨', '%'),
                ('ROE(ì§€ë°°ì£¼ì£¼)', '%'),
                ('PER(ë°°)', 'ë°°'),
                ('PBR(ë°°)', 'ë°°')
                ] %}

                {% for key, unit in target_keys %}
                {% if key in fundamentals.data %}
                <tr class="hover:bg-slate-50 transition">
                    <td
                        class="px-4 py-3 text-left font-medium text-slate-800 bg-slate-50 border-r border-slate-200 sticky left-0 z-10">
                        {{ key }} <span class="text-xs text-slate-400 font-normal">({{ unit }})</span>
                    </td>
                    {% for val in fundamentals.data[key] %}
                    <td
                        class="px-4 py-3 {% if val == '' or val == 'N/A' %}text-slate-300{% else %}font-medium{% endif %}">
                        {{ val if val else '-' }}
                    </td>
                    {% endfor %}
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- AdSense Rich Content Section -->
<div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
    <h3 class="text-lg font-bold text-slate-800 mb-3 block">ğŸ’¡ íˆ¬ì ê°€ì´ë“œ: ê¸°ìˆ ì  ì§€í‘œ(Technical Analysis)ì™€ í€€íŠ¸ ì§„ë‹¨ì˜ ì´í•´</h3>
    <p class="text-slate-600 leading-relaxed text-sm">
        ì£¼ì‹ ì‹œì¥ì—ì„œ ì¸ê°„ì˜ ê°ì •(íƒìš•ê³¼ ê³µí¬)ì„ ì™„ì „íˆ ë°°ì œí•˜ê³  ë§¤ë§¤í•˜ëŠ” ê²ƒì€ ë§¤ìš° ì–´ë µìŠµë‹ˆë‹¤. ê¸°ìˆ ì  ë¶„ì„(Technical Analysis)ì€ ê°€ê²©ê³¼ ê±°ë˜ëŸ‰ì´ë¼ëŠ” ê°ê´€ì ì¸ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹œì¥
        ì°¸ì—¬ìë“¤ì˜ ì‹¬ë¦¬ ìƒíƒœë¥¼ ì½ì–´ë‚´ëŠ” ë„êµ¬ì…ë‹ˆë‹¤. ë³¸ ì„œë¹„ìŠ¤ê°€ ì œê³µí•˜ëŠ” AI í€€íŠ¸ ì§€í‘œëŠ” ê°€ì¥ ì‹ ë¢°ë„ê°€ ë†’ì€ 3ê°€ì§€ ì§€í‘œ(ì´ë™í‰ê· ì„ ì˜ ìˆ˜ë ´ê³¼ ë°œì‚°, ìƒëŒ€ê°•ë„ì§€ìˆ˜ RSIì˜ ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„, ë³¼ë¦°ì € ë°´ë“œì˜
        í‘œì¤€í¸ì°¨ ì´íƒˆ í™•ë¥ )ë¥¼ ë³µí•©ì ìœ¼ë¡œ ì—°ì‚°í•˜ì—¬ í•˜ë‚˜ì˜ 'ì¢…í•© ì ìˆ˜(Score)'ë¡œ ë„ì¶œí•œ ê²ƒì…ë‹ˆë‹¤. ìˆ˜ë§Œ ë²ˆì˜ ë°±í…ŒìŠ¤íŒ…ì„ ê±°ì¹œ ë¡œì§ì„ ë‚´ì¥í•˜ì—¬, íˆ¬ììê°€ ê°ì •ì— íœ˜ë‘˜ë¦¬ì§€ ì•Šê³  ì² ì €íˆ í†µê³„ì— ê¸°ë°˜í•œ 'ì‹œìŠ¤í…œ
        íŠ¸ë ˆì´ë”©(System Trading)'ì˜ ì˜ì—­ì— ë‹¤ê°€ì„¤ ìˆ˜ ìˆë„ë¡ ì•ˆë‚´í•©ë‹ˆë‹¤.
    </p>
</div>

<!-- Scripts for Data Visualization -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const rawJsonData = `{{ chart_data | safe }}`;
        const data = JSON.parse(rawJsonData);
        if (!data || data.length === 0) return;

        const dates = data.map(d => d.Date);
        const opens = data.map(d => d.Open);
        const highs = data.map(d => d.High);
        const lows = data.map(d => d.Low);
        const closes = data.map(d => d.Close);

        // MA
        const ma5 = data.map(d => d.MA5);
        const ma20 = data.map(d => d.MA20);
        const ma60 = data.map(d => d.MA60);

        // Bollinger
        const bbUpper = data.map(d => d.BB_UPPER);
        const bbLower = data.map(d => d.BB_LOWER);

        // RSI
        const rsi = data.map(d => d.RSI);

        // --- 1. Candlestick Chart Base ---
        const traceCandle = {
            x: dates, open: opens, high: highs, low: lows, close: closes,
            type: 'candlestick', name: 'ê°€ê²©',
            increasing: { line: { color: '#ef4444' } },
            decreasing: { line: { color: '#3b82f6' } }
        };

        // --- 2. Moving Averages ---
        const traceMa5 = { x: dates, y: ma5, type: 'scatter', mode: 'lines', name: 'MA5', line: { color: '#f59e0b', width: 1 } };
        const traceMa20 = { x: dates, y: ma20, type: 'scatter', mode: 'lines', name: 'MA20', line: { color: '#10b981', width: 1.5 } };
        const traceMa60 = { x: dates, y: ma60, type: 'scatter', mode: 'lines', name: 'MA60', line: { color: '#8b5cf6', width: 1.5 } };

        // --- 3. Bollinger Bands ---
        const traceBbUpper = { x: dates, y: bbUpper, type: 'scatter', mode: 'lines', name: 'BB ìƒë‹¨', line: { color: '#94a3b8', width: 1, dash: 'dot' } };
        const traceBbLower = { x: dates, y: bbLower, type: 'scatter', mode: 'lines', name: 'BB í•˜ë‹¨', line: { color: '#94a3b8', width: 1, dash: 'dot' }, fill: 'tonexty', fillcolor: 'rgba(148, 163, 184, 0.1)' };

        const layoutMain = {
            margin: { t: 10, r: 10, b: 30, l: 40 },
            xaxis: { rangeslider: { visible: false }, fixedrange: true },
            yaxis: { fixedrange: true },
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            showlegend: true, legend: { orientation: 'h', y: 1.1 }
        };
        const config = { displayModeBar: false, responsive: true };

        // Initial Plot
        let mainTraces = [traceCandle, traceMa5, traceMa20, traceMa60, traceBbUpper, traceBbLower];
        Plotly.newPlot('plotly-candlestick', mainTraces, layoutMain, config);

        // Checkbox Toggle Logic
        document.getElementById('toggle-ma').addEventListener('change', function (e) {
            const visibility = e.target.checked ? true : 'legendonly';
            Plotly.restyle('plotly-candlestick', { visible: visibility }, [1, 2, 3]); // MA5,20,60 index
        });

        document.getElementById('toggle-bb').addEventListener('change', function (e) {
            const visibility = e.target.checked ? true : 'legendonly';
            Plotly.restyle('plotly-candlestick', { visible: visibility }, [4, 5]); // BB Upper, Lower index
        });

        // --- 4. RSI Chart ---
        const traceRsi = { x: dates, y: rsi, type: 'scatter', mode: 'lines', name: 'RSI(14)', line: { color: '#8b5cf6', width: 1.5 } };
        const layoutRsi = {
            margin: { t: 10, r: 10, b: 20, l: 40 },
            xaxis: { fixedrange: true },
            yaxis: { range: [0, 100], fixedrange: true },
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            shapes: [
                { type: 'line', y0: 30, y1: 30, x0: dates[0], x1: dates[dates.length - 1], line: { color: '#ef4444', width: 1, dash: 'dash' } },
                { type: 'line', y0: 70, y1: 70, x0: dates[0], x1: dates[dates.length - 1], line: { color: '#3b82f6', width: 1, dash: 'dash' } }
            ]
        };
        Plotly.newPlot('plotly-rsi', [traceRsi], layoutRsi, config);
    });
</script>
{% endif %}
{% endblock %}