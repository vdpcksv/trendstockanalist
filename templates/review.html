{% extends "base.html" %}

{% block content %}
<div class="mb-10 flex flex-col items-center text-center">
    <div
        class="inline-block bg-indigo-500/20 border border-indigo-400/30 text-indigo-300 px-4 py-1.5 rounded-full text-sm font-semibold mb-4 drop-shadow-sm">
        Quant AI Diagnostics</div>
    <h1 class="text-4xl font-extrabold text-white mb-4 tracking-tight drop-shadow-md">ê¸°ìˆ ì  ë§¤ë§¤ ë³µê¸° ë° í€€íŠ¸ ì§„ë‹¨</h1>
    <p class="text-slate-400 max-w-2xl text-lg">ê³¼ê±° ì£¼ê°€ íë¦„ì„ ì² ì €íˆ ë³µê¸°í•˜ê³ , AI ê¸°ë°˜ì˜ í€€íŠ¸ ì§€í‘œë¥¼ í†µí•´ <br class="hidden sm:block">í˜„ì¬ ì£¼ê°€ì˜
        ìƒìŠ¹ ë™ë ¥ì„ ìˆ˜ì¹˜í™”í•˜ì—¬ ê°ê´€ì ìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤.</p>
</div>

<!-- Search Form -->
<div class="glass-card rounded-2xl p-8 mb-10 hover-lift relative overflow-hidden">
    <div
        class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl pointer-events-none">
    </div>
    <form method="get" action="/review" class="flex flex-col sm:flex-row gap-4 relative z-10 w-full max-w-4xl mx-auto">
        <div class="flex-grow">
            <label for="ticker" class="sr-only">ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ</label>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none">
                    <span class="text-slate-400 text-lg">ğŸ”</span>
                </div>
                <input type="text" name="ticker" id="ticker" value="{{ search_name }}"
                    class="block w-full pl-14 pr-4 py-4 bg-[#151b30] border border-slate-700 rounded-xl leading-5 placeholder-slate-500 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base font-medium transition-all shadow-inner"
                    placeholder="ë¶„ì„í•  ì¢…ëª©ëª…(ì˜ˆ: ì‚¼ì„±ì „ì) ë˜ëŠ” ì½”ë“œ(ì˜ˆ: 005930)ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <p class="mt-3 text-sm text-slate-400 font-medium pl-2">ğŸ’¡ íŒ: ì •í™•í•œ ì¢…ëª©ëª…ì´ë‚˜ 6ìë¦¬ í‹°ì»¤ë¥¼ ì…ë ¥í•´ ì£¼ì‹œë©´ ë” ë¹ ë¦…ë‹ˆë‹¤.</p>
        </div>
        <button type="submit"
            class="w-full sm:w-auto flex justify-center items-center py-4 px-8 rounded-xl shadow-lg text-base font-bold text-white bg-gradient-to-r from-indigo-600 to-indigo-500 hover:shadow-indigo-500/30 transition-all duration-300 focus:outline-none ring-offset-[#0B1021]">
            ì°¨íŠ¸ ë° AI ì§„ë‹¨ ì‹œì‘
        </button>
    </form>
</div>

{% if error %}
<div class="bg-rose-500/10 border border-rose-500/30 text-rose-400 px-4 py-3 rounded-xl relative mb-8" role="alert">
    <span class="block sm:inline">{{ error }}</span>
</div>
{% endif %}

{% if chart_data and ai_score %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
    <!-- Chart Area -->
    <div class="glass-card rounded-2xl p-6 md:p-8 lg:col-span-2 hover-lift">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="text-indigo-400">ğŸ“Š</span> 6ê°œì›” ê¸°ìˆ ì  ìº”ë“¤ ì°¨íŠ¸ <span
                    class="bg-indigo-500/20 border border-indigo-400/30 text-indigo-300 px-3 py-1 rounded-md text-sm ml-2">{{
                    ticker }}</span>
            </h2>

            <!-- Indicator Toggles -->
            <div class="flex space-x-2 text-sm bg-[#151b30] p-1.5 rounded-xl border border-slate-700 shadow-inner">
                <label
                    class="flex items-center space-x-2 cursor-pointer px-3 py-1 rounded-lg hover:bg-slate-800 transition-colors">
                    <input type="checkbox" id="toggle-ma"
                        class="form-checkbox h-4 w-4 text-indigo-500 bg-slate-700 border-slate-600 rounded focus:ring-indigo-500 transition duration-150"
                        checked>
                    <span class="text-slate-300 font-medium select-none">ì´ë™í‰ê· ì„ </span>
                </label>
                <label
                    class="flex items-center space-x-2 cursor-pointer px-3 py-1 rounded-lg hover:bg-slate-800 transition-colors">
                    <input type="checkbox" id="toggle-bb"
                        class="form-checkbox h-4 w-4 text-indigo-500 bg-slate-700 border-slate-600 rounded focus:ring-indigo-500 transition duration-150"
                        checked>
                    <span class="text-slate-300 font-medium select-none">ë³¼ë¦°ì €ë°´ë“œ</span>
                </label>
            </div>
        </div>

        <div id="plotly-candlestick"
            class="w-full h-96 bg-[#0B1021]/50 border border-slate-700/50 rounded-xl overflow-hidden shadow-inner">
        </div>
        <div id="plotly-rsi"
            class="w-full h-40 bg-[#0B1021]/50 border border-slate-700/50 rounded-xl mt-4 overflow-hidden shadow-inner">
        </div>
    </div>

    <!-- AI Score Dashboard -->
    <div
        class="bg-gradient-to-br from-indigo-900 to-slate-900 rounded-2xl shadow-lg border border-slate-800 p-8 flex flex-col items-center justify-center text-center relative overflow-hidden hover-lift">
        <div class="absolute top-0 right-0 -mr-10 -mt-10 w-40 h-40 bg-indigo-500 opacity-20 rounded-full blur-3xl">
        </div>
        <h2
            class="text-xl font-bold mb-8 text-white w-full border-b border-slate-700/50 pb-4 flex justify-center items-center gap-2">
            <span class="text-2xl">ğŸ¤–</span> AI í€€íŠ¸ ì¢…í•© ìŠ¤ì½”ì–´
        </h2>

        <div class="relative mb-8 transform hover:scale-105 transition-transform duration-500 cursor-default">
            <!-- Score Circle -->
            <svg class="w-40 h-40 transform -rotate-90">
                <circle cx="80" cy="80" r="70" stroke="currentColor" stroke-width="14" fill="transparent"
                    class="text-slate-700/50" />
                <circle cx="80" cy="80" r="70" stroke="currentColor" stroke-width="14" fill="transparent"
                    stroke-dasharray="439.8" stroke-dashoffset="{{ 439.8 - (439.8 * ai_score.score) / 100 }}"
                    class="{% if ai_score.score >= 80 %}text-emerald-400 drop-shadow-[0_0_8px_rgba(52,211,153,0.8)]{% elif ai_score.score >= 60 %}text-blue-400 drop-shadow-[0_0_8px_rgba(96,165,250,0.8)]{% elif ai_score.score >= 40 %}text-yellow-400 drop-shadow-[0_0_8px_rgba(250,204,21,0.8)]{% else %}text-rose-500 drop-shadow-[0_0_8px_rgba(244,63,94,0.8)]{% endif %} transition-all duration-1500 ease-out"
                    stroke-linecap="round" />
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center pt-2">
                <span class="text-5xl font-extrabold text-white tracking-tighter outfit-font">{{ ai_score.score
                    }}</span>
                <span class="text-xs text-indigo-300 font-bold tracking-widest uppercase mt-1">Total Score</span>
            </div>
        </div>

        <div
            class="w-full bg-slate-800/50 backdrop-blur-sm rounded-xl p-5 text-left border border-slate-700 shadow-inner z-10">
            <h3 class="text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">í˜„ì¬ ì‹œì¥ êµ­ë©´ (Phase)</h3>
            <p
                class="text-xl font-bold {% if 'ë§¤ìˆ˜' in ai_score.phase %}text-emerald-400{% elif 'ê´€ë§' in ai_score.phase %}text-yellow-400{% else %}text-rose-400{% endif %} mb-4 drop-shadow-sm">
                {{ ai_score.phase }}</p>

            <div class="border-t border-slate-700/50 pt-4">
                <h3 class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">RSI ëª¨ë©˜í…€ ê°•ë„ (14ì¼ ê¸°ì¤€)</h3>
                <div class="flex items-center justify-between">
                    <span class="text-3xl font-extrabold text-white outfit-font">{{ ai_score.rsi }}</span>
                    <span class="text-xs font-bold text-slate-800 bg-slate-100 px-3 py-1.5 rounded-md shadow-sm">
                        {% if ai_score.rsi < 30 %}ğŸŸ¢ ê³¼ë§¤ë„ (ë°˜ë“± ëŒ€ë¹„){% elif ai_score.rsi> 70 %}ğŸ”´ ê³¼ë§¤ìˆ˜ (ì°¨ìµ ì‹¤í˜„){% else %}âšª ì¶”ì„¸
                            ì•ˆì •í˜•{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <p class="mt-6 text-[11px] text-slate-400 text-left leading-relaxed z-10 opacity-80">
            * ë³¸ AI ì§„ë‹¨ ScoreëŠ” ê°€ê²© ë‹¨ê¸° ëª¨ë©˜í…€ê³¼ ê¸°ìˆ ì  ì§€í‘œì˜ ì´ê²©ë„ë¥¼ ìˆ˜í•™ì ìœ¼ë¡œ ì—°ì‚°í•œ í€€íŠ¸ ê²°ê³¼ì…ë‹ˆë‹¤. ë§¹ì‹ ì€ ê¸ˆë¬¼ì´ë©°, ë¦¬ìŠ¤í¬ ì¡°ì ˆì˜ ë³´ì¡° ì§€í‘œë¡œë§Œ í™œìš©í•˜ì‹­ì‹œì˜¤. ë‚´ë¶€ ì „ëµì˜ ì½”ì–´
            ì•Œê³ ë¦¬ì¦˜ì€ ê³µê°œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
    </div>
</div>

{% if fundamentals and fundamentals.data %}
<!-- Fundamental Analysis Section -->
<div class="glass-card rounded-2xl p-6 md:p-8 mb-12 hover-lift">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-2">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
            <span class="text-amber-400">ğŸ¢</span> ì¬ë¬´ í€ë”ë©˜íƒˆ ë° ì»¨ì„¼ì„œìŠ¤ (Fundamental)
        </h2>
        <span
            class="text-xs text-slate-400 bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-700 font-medium whitespace-nowrap">ë°ì´í„°
            ì¶œì²˜: Npay ì¦ê¶Œ</span>
    </div>
    <p class="text-slate-400 text-sm mb-8 leading-relaxed">ìµœê·¼ 3ê°œë…„ì˜ í•µì‹¬ ì¬ë¬´ì œí‘œ(ë§¤ì¶œì•¡, ì˜ì—…ì´ìµ, ì•ˆì •ì„± ì§€í‘œ)ì™€ í–¥í›„ ì‹œì¥ì˜ ì„±ì¥ì„±
        ì»¨ì„¼ì„œìŠ¤(Estimates)ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤. ì ì ì§€ì† ë° ê³ ë¶€ì±„ ê¸°ì—…ì€ íˆ¬ìì— ê°ë³„íˆ ìœ ì˜í•˜ì‹­ì‹œì˜¤.</p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- 1. Fundamental Table (Left) -->
        <div class="overflow-x-auto pb-4 custom-scrollbar rounded-xl border border-slate-700/50 shadow-inner">
            <table class="min-w-full text-sm text-right text-slate-400 whitespace-nowrap">
                <thead class="bg-slate-800/50 border-b border-slate-700/50 text-slate-400">
                    <tr>
                        <th
                            class="px-5 py-4 text-left font-bold uppercase tracking-wider border-r border-slate-700/50 bg-[#12182B] sticky left-0 z-10 w-40 backdrop-blur-md">
                            ì£¼ìš” ì¬ë¬´ ì§€í‘œ</th>
                        {% for header in fundamentals.headers %}
                        <th class="px-5 py-4 font-bold">{{ header }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-800/50 bg-transparent">
                    {% set target_keys = [
                    ('ë§¤ì¶œì•¡', 'ì–µ ì›'),
                    ('ì˜ì—…ì´ìµ', 'ì–µ ì›'),
                    ('ë‹¹ê¸°ìˆœì´ìµ', 'ì–µ ì›'),
                    ('ë¶€ì±„ë¹„ìœ¨', '%'),
                    ('ROE(ì§€ë°°ì£¼ì£¼)', '%'),
                    ('PER(ë°°)', 'ë°°'),
                    ('PBR(ë°°)', 'ë°°')
                    ] %}

                    {% for key, unit in target_keys %}
                    {% if key in fundamentals.data %}
                    <tr class="hover:bg-indigo-500/10 transition-colors duration-200">
                        <td
                            class="px-5 py-3.5 text-left font-bold text-slate-200 bg-[#0B1021]/80 backdrop-blur-md border-r border-slate-700/50 sticky left-0 z-10">
                            {{ key }} <span class="text-xs text-slate-500 font-normal ml-1">({{ unit }})</span>
                        </td>
                        {% for val in fundamentals.data[key] %}
                        <td
                            class="px-5 py-3.5 {% if val == '' or val == 'N/A' %}text-slate-600{% else %}font-medium text-slate-300{% endif %} {% if '-' in val %}text-rose-400{% endif %}">
                            {{ val if val else '-' }}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 2. Fundamental Chart (Right) -->
        <div class="h-64 lg:h-auto border border-slate-100 shadow-inner rounded-xl p-3 bg-slate-50 relative">
            <div id="plotly-fundamental" class="w-full h-full"></div>
            <!-- Pass Data to JS -->
            <script>
                window.FUNDAMENTAL_HEADERS = {{ fundamentals.headers | tojson | safe }};
                window.FUNDAMENTAL_DATA = {{ fundamentals.data | tojson | safe }};
            </script>
        </div>
    </div>
</div>
{% endif %}

<!-- 10-Year Seasonality Analysis Section (Loaded via AJAX) -->
<div class="glass-card rounded-2xl p-6 md:p-8 mb-12 hover-lift" id="seasonality-section">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-2">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
            <span class="text-rose-400">ğŸ—“ï¸</span> 10ë…„ ì¹˜ ì›”ë³„ ìŠ¹ë¥  ë° í‰ê·  ìˆ˜ìµë¥  (ê³„ì ˆì„±)
        </h2>
        <span
            class="text-xs font-medium text-slate-400 bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-700 whitespace-nowrap">ê³¼ê±°
            10ë…„ ì¼ë´‰ ë¹…ë°ì´í„°</span>
    </div>
    <p class="text-slate-400 text-sm mb-8 leading-relaxed">ìµœê·¼ 10ë…„ê°„ í•´ë‹¹ ì¢…ëª©ì„ íŠ¹ì • ì›”ì˜ ì²« ê±°ë˜ì¼ì— ë§¤ìˆ˜í•˜ì—¬ ë§ˆì§€ë§‰ ê±°ë˜ì¼ì— ë§¤ë„í–ˆì„ ë•Œì˜ ì‹¤ì œ í†µê³„ì  ìŠ¹ë¥ ê³¼
        í‰ê·  ìˆ˜ìµë¥  ì‹œê°í™” ëª¨í˜•ì…ë‹ˆë‹¤. ë°ì´í„°ëŠ” ë°±ê·¸ë¼ìš´ë“œ ì—”ì§„ì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—°ì‚°ë©ë‹ˆë‹¤.</p>

    <div id="seasonality-loading" class="flex flex-col items-center justify-center py-12">
        <svg class="animate-spin h-8 w-8 text-indigo-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
        </svg>
        <span class="text-slate-400 text-sm font-medium">ìµœê·¼ 10ë…„ ì¹˜ ì£¼ê°€ ë°ì´í„°ë¥¼ íƒìƒ‰ ë° ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (ì•½ 1~3ì´ˆ ì†Œìš”)</span>
    </div>

    <div id="seasonality-error"
        class="hidden bg-rose-500/10 border border-rose-500/30 text-rose-400 px-4 py-4 rounded-xl text-sm font-medium text-center">
        í•´ë‹¹ ì¢…ëª©ì˜ íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ 10ë…„ì— ë¯¸ì¹˜ì§€ ëª»í•˜ê±°ë‚˜, ì¼ì‹œì ì¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    </div>

    <div id="seasonality-content" class="hidden">
        <div
            class="border border-slate-700/50 rounded-xl p-4 bg-[#0B1021]/50 shadow-inner relative overflow-x-auto text-slate-300">
            <div style="min-width: 600px;">
                <div id="plotly-seasonality-winrate" class="w-full h-24 mb-2"></div>
                <div id="plotly-seasonality-return" class="w-full h-24"></div>
            </div>
        </div>
        <div id="seasonality-insight"
            class="mt-6 bg-gradient-to-r from-indigo-900/40 to-blue-900/30 border-l-4 border-indigo-500 p-5 rounded-r-xl shadow-inner font-medium text-indigo-300 text-sm">
            <!-- Dynamic insight will be injected here -->
        </div>
    </div>
</div>

{% if sentiment_data %}
<!-- News Sentiment Analysis Section -->
<div class="glass-card rounded-2xl p-6 md:p-8 mb-12 hover-lift">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4 gap-2">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
            <span class="text-blue-400">ğŸ“°</span> ì‹œì¥ ë³´ë„ ì–¸ë¡  ë° ì—¬ë¡  ì„¼í‹°ë©˜íƒˆ ì§€ìˆ˜
        </h2>
        <span
            class="text-xs font-medium text-slate-400 bg-slate-800/50 border border-slate-700 px-3 py-1.5 rounded-lg whitespace-nowrap">ìµœê·¼
            {{ sentiment_data.total }}ê°œ ê²½ì œ ê¸°ì‚¬ ë¶„ì„</span>
    </div>

    <div class="mb-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end mb-4 gap-2">
            <div>
                <p class="text-slate-400 text-sm">ìµœê·¼ ì‹œì¥ì— ë³´ë„ëœ ë‰´ìŠ¤ í—¤ë“œë¼ì¸ì˜ ì–´ì¡°(ê¸ì •/ë¶€ì •)ë¥¼ ìì—°ì–´ ì²˜ë¦¬ë¡œ ë¶„ì„í•œ íˆ¬ì ì‹¬ë¦¬ ë‚˜ì¹¨ë°˜ì…ë‹ˆë‹¤.</p>
            </div>
            <div class="bg-[#151b30] border border-slate-700 px-3 py-1.5 rounded-lg whitespace-nowrap shadow-inner">
                <span class="text-xs font-bold text-slate-400">ê¸ì • <span class="text-emerald-400">{{
                        sentiment_data.pos_count }}</span>ê±´ / ì¤‘ë¦½ <span class="text-slate-500">{{
                        sentiment_data.neutral_count }}</span>ê±´ / ë¶€ì • <span class="text-rose-400">{{
                        sentiment_data.neg_count }}</span>ê±´</span>
            </div>
        </div>

        <!-- Sentiment Progress Bar -->
        <div class="w-full h-4 bg-slate-800/50 rounded-full overflow-hidden flex shadow-inner">
            {% if sentiment_data.positive_ratio > 0 %}
            <div class="h-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.8)] transition-all duration-1000"
                style="width: {{ sentiment_data.positive_ratio }}%;"></div>
            {% endif %}
            {% if sentiment_data.neutral_ratio > 0 %}
            <div class="h-full bg-slate-600 transition-all duration-1000"
                style="width: {{ sentiment_data.neutral_ratio }}%;"></div>
            {% endif %}
            {% if sentiment_data.negative_ratio > 0 %}
            <div class="h-full bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,0.8)] transition-all duration-1000"
                style="width: {{ sentiment_data.negative_ratio }}%;"></div>
            {% endif %}
        </div>
        <div class="flex justify-between mt-2 text-xs font-bold">
            <span class="text-emerald-400">ê¸ì • {{ sentiment_data.positive_ratio }}%</span>
            <span class="text-slate-500">ì¤‘ë¦½ {{ sentiment_data.neutral_ratio }}%</span>
            <span class="text-rose-400">ë¶€ì • {{ sentiment_data.negative_ratio }}%</span>
        </div>
    </div>

    <!-- Latest News 3-Column Grid -->
    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">

        <!-- ê¸ì • ë‰´ìŠ¤ -->
        <div class="border border-emerald-500/20 rounded-lg overflow-hidden flex flex-col bg-[#0B1021]/30">
            <div
                class="bg-emerald-500/10 px-4 py-2 border-b border-emerald-500/20 font-bold text-sm text-emerald-400 flex justify-between items-center">
                <span>ê¸ì • í—¤ë“œë¼ì¸</span>
                <span class="bg-emerald-500/20 text-emerald-300 text-xs px-2 py-0.5 rounded-full">{{
                    sentiment_data.pos_count }}ê±´</span>
            </div>
            <ul class="divide-y divide-emerald-500/10 text-sm flex-1">
                {% for news in sentiment_data.news_list if news.sentiment == 'positive' %}
                <li class="px-4 py-3 flex items-start gap-3 hover:bg-emerald-500/5 transition">
                    <span class="text-slate-300 leading-snug">{{ news.title }}</span>
                </li>
                {% else %}
                <li class="px-4 py-6 flex items-center justify-center text-slate-500 text-xs italic bg-[#0B1021]/50">ì¡°íšŒëœ
                    ê¸ì •
                    ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                {% endfor %}
            </ul>
        </div>

        <!-- ì¤‘ë¦½ ë‰´ìŠ¤ -->
        <div class="border border-slate-700/50 rounded-lg overflow-hidden flex flex-col bg-[#0B1021]/30">
            <div
                class="bg-slate-800/50 px-4 py-2 border-b border-slate-700/50 font-bold text-sm text-slate-300 flex justify-between items-center">
                <span>ì¤‘ë¦½ í—¤ë“œë¼ì¸</span>
                <span class="bg-slate-700/50 text-slate-400 text-xs px-2 py-0.5 rounded-full">{{
                    sentiment_data.neutral_count }}ê±´</span>
            </div>
            <ul class="divide-y divide-slate-800/50 text-sm flex-1">
                {% for news in sentiment_data.news_list if news.sentiment == 'neutral' %}
                <li class="px-4 py-3 flex items-start gap-3 hover:bg-slate-800/30 transition">
                    <span class="text-slate-300 leading-snug">{{ news.title }}</span>
                </li>
                {% else %}
                <li class="px-4 py-6 flex items-center justify-center text-slate-500 text-xs italic bg-[#0B1021]/50">ì¡°íšŒëœ
                    ì¤‘ë¦½
                    ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                {% endfor %}
            </ul>
        </div>

        <!-- ë¶€ì • ë‰´ìŠ¤ -->
        <div class="border border-rose-500/20 rounded-lg overflow-hidden flex flex-col bg-[#0B1021]/30">
            <div
                class="bg-rose-500/10 px-4 py-2 border-b border-rose-500/20 font-bold text-sm text-rose-400 flex justify-between items-center">
                <span>ë¶€ì • í—¤ë“œë¼ì¸</span>
                <span class="bg-rose-500/20 text-rose-300 text-xs px-2 py-0.5 rounded-full">{{ sentiment_data.neg_count
                    }}ê±´</span>
            </div>
            <ul class="divide-y divide-rose-500/10 text-sm flex-1">
                {% for news in sentiment_data.news_list if news.sentiment == 'negative' %}
                <li class="px-4 py-3 flex items-start gap-3 hover:bg-rose-500/5 transition">
                    <span class="text-slate-300 leading-snug">{{ news.title }}</span>
                </li>
                {% else %}
                <li class="px-4 py-6 flex items-center justify-center text-slate-500 text-xs italic bg-[#0B1021]/50">ì¡°íšŒëœ
                    ë¶€ì •
                    ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                {% endfor %}
            </ul>
        </div>

    </div>
</div>
{% endif %}

<!-- AdSense Rich Content Section -->
<div class="glass-card p-6 rounded-xl border border-indigo-500/20 relative overflow-hidden">
    <div
        class="absolute top-0 right-0 -mr-16 -mt-16 w-32 h-32 bg-indigo-500/10 rounded-full blur-3xl pointer-events-none">
    </div>
    <h3 class="text-lg font-bold text-white mb-3 block relative z-10 flex items-center gap-2"><span
            class="text-amber-400">ğŸ’¡</span> íˆ¬ì ê°€ì´ë“œ: ê¸°ìˆ ì  ì§€í‘œ(Technical Analysis)ì™€ í€€íŠ¸ ì§„ë‹¨ì˜ ì´í•´</h3>
    <p class="text-slate-400 leading-relaxed text-sm relative z-10">
        ì£¼ì‹ ì‹œì¥ì—ì„œ ì¸ê°„ì˜ ê°ì •(íƒìš•ê³¼ ê³µí¬)ì„ ì™„ì „íˆ ë°°ì œí•˜ê³  ë§¤ë§¤í•˜ëŠ” ê²ƒì€ ë§¤ìš° ì–´ë µìŠµë‹ˆë‹¤. ê¸°ìˆ ì  ë¶„ì„(Technical Analysis)ì€ ê°€ê²©ê³¼ ê±°ë˜ëŸ‰ì´ë¼ëŠ” ê°ê´€ì ì¸ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹œì¥
        ì°¸ì—¬ìë“¤ì˜ ì‹¬ë¦¬ ìƒíƒœë¥¼ ì½ì–´ë‚´ëŠ” ë„êµ¬ì…ë‹ˆë‹¤. ë³¸ ì„œë¹„ìŠ¤ê°€ ì œê³µí•˜ëŠ” AI í€€íŠ¸ ì§€í‘œëŠ” ê°€ì¥ ì‹ ë¢°ë„ê°€ ë†’ì€ 3ê°€ì§€ ì§€í‘œ(ì´ë™í‰ê· ì„ ì˜ ìˆ˜ë ´ê³¼ ë°œì‚°, ìƒëŒ€ê°•ë„ì§€ìˆ˜ RSIì˜ ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„, ë³¼ë¦°ì € ë°´ë“œì˜
        í‘œì¤€í¸ì°¨ ì´íƒˆ í™•ë¥ )ë¥¼ ë³µí•©ì ìœ¼ë¡œ ì—°ì‚°í•˜ì—¬ í•˜ë‚˜ì˜ 'ì¢…í•© ì ìˆ˜(Score)'ë¡œ ë„ì¶œí•œ ê²ƒì…ë‹ˆë‹¤. ìˆ˜ë§Œ ë²ˆì˜ ë°±í…ŒìŠ¤íŒ…ì„ ê±°ì¹œ ë¡œì§ì„ ë‚´ì¥í•˜ì—¬, íˆ¬ììê°€ ê°ì •ì— íœ˜ë‘˜ë¦¬ì§€ ì•Šê³  ì² ì €íˆ í†µê³„ì— ê¸°ë°˜í•œ 'ì‹œìŠ¤í…œ
        íŠ¸ë ˆì´ë”©(System Trading)'ì˜ ì˜ì—­ì— ë‹¤ê°€ì„¤ ìˆ˜ ìˆë„ë¡ ì•ˆë‚´í•©ë‹ˆë‹¤.
    </p>
</div>

<!-- Scripts for Data Visualization -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const rawJsonData = `{{ chart_data | safe }}`;
        const data = JSON.parse(rawJsonData);
        if (!data || data.length === 0) return;

        const dates = data.map(d => d.Date);
        const opens = data.map(d => d.Open);
        const highs = data.map(d => d.High);
        const lows = data.map(d => d.Low);
        const closes = data.map(d => d.Close);

        // MA
        const ma5 = data.map(d => d.MA5);
        const ma20 = data.map(d => d.MA20);
        const ma60 = data.map(d => d.MA60);

        // Bollinger
        const bbUpper = data.map(d => d.BB_UPPER);
        const bbLower = data.map(d => d.BB_LOWER);

        // RSI
        const rsi = data.map(d => d.RSI);

        // --- 1. Candlestick Chart Base ---
        const traceCandle = {
            x: dates, open: opens, high: highs, low: lows, close: closes,
            type: 'candlestick', name: 'ê°€ê²©',
            increasing: { line: { color: '#ef4444' } },
            decreasing: { line: { color: '#3b82f6' } }
        };

        // --- 2. Moving Averages ---
        const traceMa5 = { x: dates, y: ma5, type: 'scatter', mode: 'lines', name: 'MA5', line: { color: '#f59e0b', width: 1 } };
        const traceMa20 = { x: dates, y: ma20, type: 'scatter', mode: 'lines', name: 'MA20', line: { color: '#10b981', width: 1.5 } };
        const traceMa60 = { x: dates, y: ma60, type: 'scatter', mode: 'lines', name: 'MA60', line: { color: '#8b5cf6', width: 1.5 } };

        // --- 3. Bollinger Bands ---
        const traceBbUpper = { x: dates, y: bbUpper, type: 'scatter', mode: 'lines', name: 'BB ìƒë‹¨', line: { color: '#94a3b8', width: 1, dash: 'dot' } };
        const traceBbLower = { x: dates, y: bbLower, type: 'scatter', mode: 'lines', name: 'BB í•˜ë‹¨', line: { color: '#94a3b8', width: 1, dash: 'dot' }, fill: 'tonexty', fillcolor: 'rgba(148, 163, 184, 0.1)' };

        const layoutMain = {
            margin: { t: 10, r: 10, b: 30, l: 40 },
            xaxis: { rangeslider: { visible: false }, fixedrange: false },
            yaxis: { fixedrange: false, autorange: true },
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            showlegend: true, legend: { orientation: 'h', y: 1.1 }
        };
        const config = { displayModeBar: false, responsive: true, scrollZoom: true };

        // Initial Plot
        let mainTraces = [traceCandle, traceMa5, traceMa20, traceMa60, traceBbUpper, traceBbLower];
        Plotly.newPlot('plotly-candlestick', mainTraces, layoutMain, config);

        // Checkbox Toggle Logic
        document.getElementById('toggle-ma').addEventListener('change', function (e) {
            const visibility = e.target.checked ? true : 'legendonly';
            Plotly.restyle('plotly-candlestick', { visible: visibility }, [1, 2, 3]); // MA5,20,60 index
        });

        document.getElementById('toggle-bb').addEventListener('change', function (e) {
            const visibility = e.target.checked ? true : 'legendonly';
            Plotly.restyle('plotly-candlestick', { visible: visibility }, [4, 5]); // BB Upper, Lower index
        });

        // --- 4. RSI Chart ---
        const traceRsi = { x: dates, y: rsi, type: 'scatter', mode: 'lines', name: 'RSI(14)', line: { color: '#8b5cf6', width: 1.5 } };
        const layoutRsi = {
            margin: { t: 10, r: 10, b: 20, l: 40 },
            xaxis: { fixedrange: false, tickfont: { color: '#94a3b8' }, gridcolor: '#334155' },
            yaxis: { range: [0, 100], fixedrange: true, tickfont: { color: '#94a3b8' }, gridcolor: '#334155' },
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#cbd5e1' },
            shapes: [
                { type: 'line', y0: 30, y1: 30, x0: dates[0], x1: dates[dates.length - 1], line: { color: '#ef4444', width: 1, dash: 'dash' } },
                { type: 'line', y0: 70, y1: 70, x0: dates[0], x1: dates[dates.length - 1], line: { color: '#3b82f6', width: 1, dash: 'dash' } }
            ]
        };
        Plotly.newPlot('plotly-rsi', [traceRsi], layoutRsi, config);
    });

    // --- 5. Fundamental Chart ---
    document.addEventListener("DOMContentLoaded", function () {
        if (!window.FUNDAMENTAL_DATA || !window.FUNDAMENTAL_HEADERS || !document.getElementById('plotly-fundamental')) return;

        const headers = window.FUNDAMENTAL_HEADERS;
        const data = window.FUNDAMENTAL_DATA;

        const sales = data['ë§¤ì¶œì•¡'];
        const opProfit = data['ì˜ì—…ì´ìµ'];

        if (!sales || !opProfit) return;

        // Convert string formatted numbers (like '1,234') to actual floats, fallback to 0 if 'N/A' or empty
        const parseNum = (val) => {
            if (!val || val === '-' || val === 'N/A') return 0;
            return parseFloat(val.toString().replace(/,/g, ''));
        };

        const traceSales = {
            x: headers,
            y: sales.map(parseNum),
            name: 'ë§¤ì¶œì•¡',
            type: 'bar',
            marker: { color: '#3b82f6' }
        };

        const traceOpProfit = {
            x: headers,
            y: opProfit.map(parseNum),
            name: 'ì˜ì—…ì´ìµ',
            type: 'bar',
            marker: { color: '#10b981' }
        };

        const layoutFundamental = {
            barmode: 'group',
            margin: { t: 30, r: 10, b: 30, l: 40 },
            title: { text: 'ë§¤ì¶œì•¡ ë° ì˜ì—…ì´ìµ ì¶”ì´ (ì–µ ì›)', font: { size: 14, color: '#94a3b8' } },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#cbd5e1' },
            xaxis: { tickfont: { color: '#94a3b8' } },
            yaxis: { gridcolor: '#334155', tickfont: { color: '#94a3b8' }, zerolinecolor: '#64748b' },
            showlegend: true,
            legend: { orientation: 'h', y: 1.15 }
        };

        Plotly.newPlot('plotly-fundamental', [traceSales, traceOpProfit], layoutFundamental, { displayModeBar: false, responsive: true });
    });

    // --- 6. Seasonality Data Fetch (AJAX) ---
    document.addEventListener("DOMContentLoaded", function () {
        const ticker = "{{ ticker }}";
        if (!ticker || ticker === "None") return;

        fetch(`/api/stock_seasonality/${ticker}`)
            .then(res => res.json())
            .then(response => {
                document.getElementById('seasonality-loading').classList.add('hidden');

                if (response.status !== 'success' || !response.data) {
                    document.getElementById('seasonality-error').classList.remove('hidden');
                    return;
                }

                document.getElementById('seasonality-content').classList.remove('hidden');

                const data = response.data;
                const months = data.map(d => d.Month + 'ì›”');
                const winRates = data.map(d => d.WinRate);
                const avgReturns = data.map(d => d.AvgReturn);

                // Win Rate Heatmap
                Plotly.newPlot('plotly-seasonality-winrate', [{
                    z: [winRates],
                    x: months,
                    y: ['ìŠ¹ë¥ (%)'],
                    type: 'heatmap',
                    colorscale: [[0, '#f87171'], [0.5, '#fef08a'], [1, '#4ade80']],
                    zmin: 0, zmax: 100,
                    text: [winRates.map(v => v + '%')],
                    texttemplate: "<b>%{text}</b>",
                    showscale: false,
                    hoverinfo: 'x+y+z'
                }], {
                    margin: { t: 10, r: 20, b: 20, l: 80 },
                    xaxis: { fixedrange: true },
                    yaxis: { fixedrange: true },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                }, { displayModeBar: false, responsive: true });

                // Avg Return Heatmap
                const maxAbs = Math.max(...avgReturns.map(Math.abs));
                const bound = maxAbs > 0 ? maxAbs : 1;

                Plotly.newPlot('plotly-seasonality-return', [{
                    z: [avgReturns],
                    x: months,
                    y: ['ìˆ˜ìµë¥ (%)'],
                    type: 'heatmap',
                    colorscale: [[0, '#3b82f6'], [0.5, '#f8fafc'], [1, '#ef4444']], // Blue, White, Red
                    zmin: -bound, zmax: bound,
                    text: [avgReturns.map(v => v > 0 ? '+' + v + '%' : v + '%')],
                    texttemplate: "<b>%{text}</b>",
                    showscale: false,
                    hoverinfo: 'x+y+z'
                }], {
                    margin: { t: 10, r: 20, b: 20, l: 80 },
                    xaxis: { fixedrange: true },
                    yaxis: { fixedrange: true },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                }, { displayModeBar: false, responsive: true });

                let bestMonthIdx = 0;
                let maxWinRate = -1;
                for (let i = 0; i < winRates.length; i++) {
                    if (winRates[i] > maxWinRate) {
                        maxWinRate = winRates[i];
                        bestMonthIdx = i;
                    } else if (winRates[i] === maxWinRate) {
                        if (avgReturns[i] > avgReturns[bestMonthIdx]) {
                            bestMonthIdx = i;
                        }
                    }
                }

                const bestMonth = data[bestMonthIdx];
                if (bestMonth && bestMonth.WinRate > 0) {
                    document.getElementById('seasonality-insight').innerHTML =
                        `<p class="text-sm font-medium text-indigo-300">ğŸ’¡ <strong>AI ê³¼ê±° 10ë…„ í†µê³„ ë¶„ì„:</strong> 1ë…„ ì¤‘ <strong>${bestMonth.Month}ì›”</strong>ì— ë§¤ìˆ˜í•˜ì—¬ ì›”ë§ì— ë§¤ë„í–ˆì„ ë•Œ ìŠ¹ë¥  <strong>${bestMonth.WinRate}%</strong>, í‰ê·  ìˆ˜ìµë¥  <strong class="${bestMonth.AvgReturn > 0 ? 'text-rose-400' : 'text-indigo-400'}">${bestMonth.AvgReturn > 0 ? '+' : ''}${bestMonth.AvgReturn}%</strong>ë¡œ íˆ¬ìê°€ ê°€ì¥ ìœ ë¦¬í–ˆìŠµë‹ˆë‹¤.</p>`;
                } else {
                    document.getElementById('seasonality-insight').innerHTML =
                        `<p class="text-sm font-medium text-slate-300">ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ë¶„ì„í•˜ê¸° ë¶€ì¡±í•©ë‹ˆë‹¤.</p>`;
                }

            })
            .catch(err => {
                console.error(err);
                document.getElementById('seasonality-loading').classList.add('hidden');
                document.getElementById('seasonality-error').classList.remove('hidden');
            });
    });
</script>
{% endif %}
{% endblock %}