{% extends "base.html" %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-slate-900 mb-2">ë‹¹ì¼ ì£¼ë„ í…Œë§ˆ ë§ì¶¤í˜• ì‹œë‚˜ë¦¬ì˜¤</h1>
    <p class="text-slate-600 max-w-3xl">Npay ì¦ê¶Œì˜ ì‹¤ì‹œê°„ í…Œë§ˆ ì‹œì„¸ë¥¼ ë¶„ì„í•˜ì—¬, ì˜¤ëŠ˜ ì‹œì¥ì„ ì£¼ë„í•˜ëŠ” í…Œë§ˆì™€ í¸ì… ì¢…ëª©ë“¤ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.</p>
</div>

{% if error %}
<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative" role="alert">
    <span class="block sm:inline">{{ error }}</span>
</div>
{% else %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">

    <!-- Theme Selection form -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
        <h2 class="text-lg font-semibold mb-4 text-slate-800">ğŸ”¥ ì˜¤ëŠ˜ì˜ í•« í…Œë§ˆ ë¦¬ìŠ¤íŠ¸ (Top 20)</h2>

        <form method="get" action="/themes" class="space-y-4">
            <div>
                <label for="theme" class="block text-sm font-medium text-slate-700 mb-1">ğŸ’¡ ê¹Šê²Œ íŒŒë³´ê³  ì‹¶ì€ ê´€ì‹¬ í…Œë§ˆ ì„ íƒ</label>
                <select id="theme" name="theme"
                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md border">
                    <option value="" disabled {% if not selected_theme_data %}selected{% endif %}>í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    {% for t in themes %}
                    <option value="{{ t['í…Œë§ˆëª…'] }}" {% if selected_theme_data and selected_theme_data['í…Œë§ˆëª…']==t['í…Œë§ˆëª…']
                        %}selected{% endif %}>
                        {{ t['í…Œë§ˆëª…'] }} ({{ t['ë“±ë½ë¥ (%)'] }}%)
                    </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                í…Œë§ˆ ë¶„ì„í•˜ê¸°
            </button>
        </form>

        {% if selected_theme_data %}
        <div class="mt-6 p-4 bg-indigo-50 rounded-lg text-center">
            <span class="text-3xl block mb-2">ğŸš€</span>
            <p class="font-medium text-indigo-900">
                ì„ íƒí•˜ì‹  '{{ selected_theme_data['í…Œë§ˆëª…'] }}' í…Œë§ˆì˜<br>
                ì˜¤ëŠ˜ í‰ê·  ë“±ë½ë¥ ì€ <strong class="text-xl">{{ selected_theme_data['ë“±ë½ë¥ (%)'] }}%</strong> ì…ë‹ˆë‹¤.
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Theme Details & Lotto -->
    <div class="lg:col-span-2 space-y-8">
        {% if selected_theme_data %}
        <!-- Stocks Table -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
            <h2 class="text-lg font-semibold mb-2 text-slate-800">'{{ selected_theme_data['í…Œë§ˆëª…'] }}' í…Œë§ˆ í•µì‹¬ í¸ì… ì¢…ëª©</h2>
            <p class="text-sm text-slate-500 mb-4">í•´ë‹¹ í…Œë§ˆì— í¸ì…ëœ ì£¼ìš” ì¢…ëª©ì˜ ì‹¤ì‹œê°„ ì‹œì„¸ì…ë‹ˆë‹¤.</p>

            {% if stocks_data %}
            <div class="overflow-x-auto border border-slate-200 rounded-lg">
                <table class="min-w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-3">ì¢…ëª©ëª…</th>
                            <th class="px-4 py-3 text-right">í˜„ì¬ê°€</th>
                            <th class="px-4 py-3 text-right">ë“±ë½ë¥ </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stock in stocks_data %}
                        <tr class="bg-white border-b hover:bg-slate-50 transition">
                            <td class="px-4 py-3 font-medium text-slate-900">{{ stock['ì¢…ëª©ëª…'] }}</td>
                            <td class="px-4 py-3 text-right">{{ stock['í˜„ì¬ê°€'] }}</td>
                            <td
                                class="px-4 py-3 text-right {% if '+' in stock['ë“±ë½ë¥ '] %}text-red-500{% elif '-' in stock['ë“±ë½ë¥ '] %}text-blue-500{% endif %} font-medium">
                                {{ stock['ë“±ë½ë¥ '] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Momentum Feature (Premium Only) -->
            <div id="lotto-container"
                class="mt-8 bg-slate-50 border border-slate-200 rounded-xl p-6 text-center shadow-sm">
                <h3 class="text-xl font-bold text-slate-800 mb-2">ğŸ“Š ì˜¤ëŠ˜ì˜ '{{ selected_theme_data['í…Œë§ˆëª…'] }}' ëª¨ë©˜í…€ ê°•ì„¸ ì¢…ëª©
                    ë¶„ì„!
                </h3>
                <p class="text-slate-600 mb-6 text-sm">í•´ë‹¹ í…Œë§ˆ ë‚´ì—ì„œ ê°€ì¥ ëª¨ë©˜í…€(ë“±ë½ë¥ )ì´ ê°•í•œ ìœ ë§ ì¢…ëª© í•˜ë‚˜ë¥¼ AIê°€ ë¶„ì„í•´ ë“œë¦½ë‹ˆë‹¤.</p>
                <button onclick="drawLotto()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-md shadow-sm transition">
                    ì˜¤ëŠ˜ì˜ ëª¨ë©˜í…€ ê°•ì„¸ ì¢…ëª© ë¶„ì„í•˜ê¸°
                </button>
                <!-- Result Modal / Card hidden by default -->
                <div id="lotto-result" class="hidden mt-6 p-4 bg-white rounded-lg shadow-sm border border-slate-200">
                    <!-- Filled via JS -->
                </div>
            </div>

            {% else %}
            <p class="text-slate-500">ì¢…ëª© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>

        <!-- AI Comment -->
        {% if ai_comment %}
        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
            <h2 class="text-lg font-semibold mb-4 text-slate-800">ğŸ¤– AI íˆ¬ì ì‹œë‚˜ë¦¬ì˜¤ íŒë‹¨</h2>
            <div class="flex items-start">
                <div class="flex-grow">
                    <h3 class="font-bold text-lg text-indigo-700">{{ ai_comment.title }}</h3>
                    <p class="mt-2 text-slate-600">{{ ai_comment.desc }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% else %}
        <!-- Initial State empty container placeholder -->
        <div
            class="bg-slate-50 rounded-xl border border-dashed border-slate-300 p-12 flex items-center justify-center text-slate-400 h-full">
            ì¢Œì¸¡ì—ì„œ ê´€ì‹¬ í…Œë§ˆë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.
        </div>
        {% endif %}
    </div>
</div>

<!-- AdSense Rich Content Section -->
<div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
    <h3 class="text-lg font-bold text-slate-800 mb-3 block">ğŸ’¡ íˆ¬ì ê°€ì´ë“œ: í…Œë§ˆ íƒ‘ë‹¤ìš´(Top-Down) ì–´í”„ë¡œì¹˜ ì „ëµ</h3>
    <p class="text-slate-600 leading-relaxed text-sm">
        ì´ˆë³´ íˆ¬ììë“¤ì´ í”íˆ í•˜ëŠ” ì‹¤ìˆ˜ëŠ” 'ì¢‹ì•„ ë³´ì´ëŠ” ì¢…ëª©'ì„ ê°œë³„ì ìœ¼ë¡œ ë§¤ìˆ˜í•˜ëŠ” ë°”í…€ì—…(Bottom-Up) ë°©ì‹ì— ì˜ì¡´í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì§„ì§œ ì‹œì¥ì˜ íŠ¸ë Œë“œ ì„¸í„°ë“¤ì€ í˜„ì¬ ì–´ë–¤ 'í…Œë§ˆ'ì™€ 'ì‚°ì—…êµ°'ì— ëˆì´
        ëª°ë¦¬ëŠ”ì§€ë¥¼ ë¨¼ì € íŒŒì•…í•˜ëŠ” íƒ‘ë‹¤ìš´ ì ‘ê·¼ë²•ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ë³¸ íƒ­ì—ì„œëŠ” ë„¤ì´ë²„í˜ì´ ì¦ê¶Œì˜ ì‹¤ì‹œê°„ í…Œë§ˆ ì‹œì„¸ë¥¼ ë¶„ì„í•´ ê°€ì¥ ëª¨ë©˜í…€ì´ ê°•í•œ ì£¼ë„ ì„¹í„°ë¥¼ ì°¾ì•„ëƒ…ë‹ˆë‹¤. í•«í•œ ì‹œë‚˜ë¦¬ì˜¤ì— íƒ‘ìŠ¹í•˜ì—¬ ëŒ€ì¥ì£¼ ìœ„ì£¼ì˜
        í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ êµ¬ì„±í•˜ë©´ ì‹œì¥ ìˆ˜ìµë¥ (Alpha)ì„ ë›°ì–´ë„˜ëŠ” ê²°ê³¼ë¥¼ ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>
</div>

<!-- Confetti Canvas for Lotto Effect -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const membership = localStorage.getItem('membership') || 'basic';

        // 1. Paywall: Limit Top 5 themes for basic users
        const themeSelect = document.getElementById('theme');
        if (themeSelect && membership !== 'premium') {
            const options = themeSelect.querySelectorAll('option');
            // Index 0 is placeholder, so options 1 to 5 are allowed. Hide the rest.
            for (let i = 6; i < options.length; i++) {
                options[i].disabled = true;
                options[i].textContent = "ğŸ”’ " + options[i].textContent.replace(/ \(.+/, " (Premium ì „ìš©)");
            }
        }

        // 2. Paywall: Hide Lotto feature for basic users
        const lottoContainer = document.getElementById('lotto-container');
        if (lottoContainer) {
            if (membership !== 'premium') {
                lottoContainer.innerHTML = `
                    <h3 class="text-xl font-bold text-slate-800 mb-2">ğŸ”’ ì˜¤ëŠ˜ì˜ '{{ selected_theme_data['í…Œë§ˆëª…'] if selected_theme_data else '' }}' ëª¨ë©˜í…€ ê°•ì„¸ ì¢…ëª© ë¶„ì„ (Premium)</h3>
                    <p class="text-slate-600 mb-6 text-sm">í”„ë¦¬ë¯¸ì—„ íšŒì›ì—ê²Œë§Œ AIê°€ í•´ë‹¹ í…Œë§ˆ ë‚´ ìµœê³ ì˜ ë‹¨ê¸° ëª¨ë©˜í…€ ì¢…ëª©ì„ ë¶„ì„í•´ ë“œë¦½ë‹ˆë‹¤.</p>
                    <button onclick="openAuthModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-md shadow-sm transition">í”„ë¦¬ë¯¸ì—„ êµ¬ë… (ë¡œê·¸ì¸)</button>
                `;
            }
        }
    });
</script>

<script>
    {% if stocks_data %}
    const stocksList = {{ stocks_data | tojson | safe }};

    function parseRate(rateStr) {
        try {
            return parseFloat(rateStr.replace('%', '').replace('+', '').trim()) || 0;
        } catch {
            return 0;
        }
    }

    function drawLotto() {
        if (!stocksList || stocksList.length === 0) return;

        // 1. Sort by Rate
        const sorted = [...stocksList].sort((a, b) => parseRate(b['ë“±ë½ë¥ ']) - parseRate(a['ë“±ë½ë¥ ']));

        // 2. Pick top 3 and select 1 randomly for excitement
        const topCandidates = sorted.slice(0, 3);
        const randomIdx = Math.floor(Math.random() * topCandidates.length);
        const luckyStock = topCandidates[randomIdx];

        // 3. Fire Confetti
        var duration = 3000;
        var end = Date.now() + duration;

        (function frame() {
            confetti({
                particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#ff0000', '#00ff00', '#0000ff']
            });
            confetti({
                particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#ff0000', '#00ff00', '#0000ff']
            });

            if (Date.now() < end) requestAnimationFrame(frame);
        }());

        // 4. Show Result
        const resDiv = document.getElementById('lotto-result');
        resDiv.classList.remove('hidden');
        resDiv.innerHTML = `
            <div class="text-lg font-medium text-slate-800 mb-2">
                ì˜¤ëŠ˜ì˜ ëª¨ë©˜í…€ ê°•ì„¸ ì¢…ëª©ì€ <span class="text-indigo-600 font-bold text-xl">[${luckyStock['ì¢…ëª©ëª…']}]</span> ì…ë‹ˆë‹¤.
            </div>
            <div class="mt-2 flex justify-center space-x-4 text-sm font-medium">
                <span class="bg-slate-100 px-3 py-1 rounded">í˜„ì¬ê°€: ${luckyStock['í˜„ì¬ê°€']}</span>
                <span class="bg-red-50 text-red-600 px-3 py-1 rounded border border-red-100">ë“±ë½ë¥ : ${luckyStock['ë“±ë½ë¥ ']}</span>
            </div>
            <p class="mt-4 text-xs text-slate-500">ë‹¨ê¸° ëª¨ë©˜í…€ì´ ë§¤ìš° ê°•í•˜ê²Œ ë“¤ì–´ì˜¤ê³  ìˆëŠ” ëŒ€ì¥ì£¼ê¸‰ ì¢…ëª©ì…ë‹ˆë‹¤. íˆ¬ìëŠ” ì‹ ì¤‘í•˜ê²Œ ê²°ì •í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
        `;
    }
    {% endif %}
</script>
{% endif %}
{% endblock %}